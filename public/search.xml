<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>使用ImageJ批量合并细胞荧光图像</title>
      <link href="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/"/>
      <url>/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="使用-ImageJ-批量合并细胞荧光图像"><a href="#使用-ImageJ-批量合并细胞荧光图像" class="headerlink" title="使用 ImageJ 批量合并细胞荧光图像"></a>使用 ImageJ 批量合并细胞荧光图像</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在以慢病毒为载体的转基因操作中，载体序列上通常会带有荧光信号作为基因转入成功与否的标志，通常我们需要对比计数明场和荧光图像，计算感染率，这就需要合并两张图像。</p><p>FIJI (Fiji is just ImageJ) 是一种基于 Java 的跨平台开源图像处理软件，相较于其他的图像处理软件，免费、轻量化、精度高，是处理实验拍摄图像的首选。</p><p>我们首先讲解单个样本的手动处理，后面介绍如何使用宏命令批量处理。</p><h2 id="手动处理的详细步骤"><a href="#手动处理的详细步骤" class="headerlink" title="手动处理的详细步骤"></a>手动处理的详细步骤</h2><h3 id="明场图像的处理"><a href="#明场图像的处理" class="headerlink" title="明场图像的处理"></a>明场图像的处理</h3><p>明场图像可以观察所有细胞，作为计数荧光信号的背景，因此需要降低亮度，避免过亮的背景掩盖荧光信号。</p><p>通常有以下的几个步骤：</p><ol><li>RGB 转灰度</li></ol><p>将原来 RGB 三通道的明场图像转换成 8 位灰度图，因为我们后续只将其作为一个通道。</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/1_rgb2gray.png"></p><ol start="2"><li>调整亮度对比度</li></ol><p>原始的明场图像我采集的时候曝光时间比较短，所以本身就比较暗，建议还是采图的时候多曝光一会儿，不然调整亮度后会有很多噪点。</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/2_gray_before.png"></p><p>使用 ImageJ 的 Adjust -&gt; Brightness&#x2F;Contrast 菜单，调整灰度的最大值与最小值，使得整体变暗同时对比度加大。</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/3_menu_B&C.png"></p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/4_B&C.png"></p><p>调整后的图像：</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/5_gray_after.png"></p><h3 id="荧光图像的处理"><a href="#荧光图像的处理" class="headerlink" title="荧光图像的处理"></a>荧光图像的处理</h3><p>荧光图像因为是彩色图像，首先需要将色彩通道拆分开，然后再调整亮度对比度。</p><ol><li>使用 Image -&gt; Color -&gt; Split Channels 菜单从彩色图像中单独取出自己需要的通道，比方说演示中使用的是红色通道，因此拆分后只取红色，关闭蓝色和绿色。</li></ol><p>拆分前：</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/6_red_before.png"></p><p>拆分操作：</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/7_menu_split_channels.png"></p><p>拆分后：</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/8_red_split_channels.png"></p><p>拆分后的图像同样是一个单通道的灰度图。</p><ol start="2"><li>亮度对比度调整</li></ol><p>荧光图像同样需要调整亮度对比度，这次调整的目的是降低背景的亮度，剔除一部分非特异荧光，然后将我们需要的信号亮度调明显。同样是调整最大最小值，最大值可以比明场调得更小一点，这样荧光会更明显。</p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/9_red_after.png"></p><h3 id="合并图像"><a href="#合并图像" class="headerlink" title="合并图像"></a>合并图像</h3><ol><li>使用 Image -&gt; Color -&gt; Merge Channels 菜单将明场和荧光图像合并。注意勾选保留原始图片，给自己留一个重新调整的机会。</li></ol><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/10_menu_merge_channels.png"></p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/11_merge_channels.png"></p><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/12_merge_after.png"></p><ol start="2"><li>合并后的图像是堆叠的 8 位图像，需要转化为 RGB 真彩，使用 Image -&gt; Type -&gt; RGB Color</li></ol><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/13_rgb_color.png"></p><ol start="3"><li>保存图像。</li></ol><h2 id="使用宏命令进行批量处理"><a href="#使用宏命令进行批量处理" class="headerlink" title="使用宏命令进行批量处理"></a>使用宏命令进行批量处理</h2><p>宏命令是 ImageJ 中的一个自动化功能，可以固定记录下图像处理的步骤，在大批量处理时节省了很多的时间和精力，更重要的是可以保证图像处理结果的一致性。</p><p>整体处理的步骤和手动操作是一样的，具体的命令与参数在相应步骤中讲解：</p><h3 id="明场图像的处理-1"><a href="#明场图像的处理-1" class="headerlink" title="明场图像的处理"></a>明场图像的处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">process_gray</span><span class="params">(grayTitle)</span> &#123;</span><br><span class="line">    selectWindow(grayTitle); <span class="comment">// 选择gray图像窗口</span></span><br><span class="line">    run(<span class="string">&quot;8-bit&quot;</span>); <span class="comment">// 转换为8位图像</span></span><br><span class="line">    run(<span class="string">&quot;Set Measurements...&quot;</span>, <span class="string">&quot;mean standard redirect=None decimal=3&quot;</span>); <span class="comment">// 设置测量参数</span></span><br><span class="line">    run(<span class="string">&quot;Measure&quot;</span>); <span class="comment">// 测量图像统计信息</span></span><br><span class="line">    gray_mean = getResult(<span class="string">&quot;Mean&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取平均灰度值</span></span><br><span class="line">    gray_std = getResult(<span class="string">&quot;StdDev&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取灰度标准差</span></span><br><span class="line">    <span class="comment">// 计算gray图像的显示范围（均值 -2 个标准差到 +6 个标准差之间）</span></span><br><span class="line">    <span class="comment">// 这个标准差范围是我尝试出来比较合适的，大家也可以自己多试几次，找到适合自己实验的数值</span></span><br><span class="line">    minGray = Math.max(gray_mean - <span class="number">2</span> * gray_std, <span class="number">0</span>);</span><br><span class="line">    maxGray = Math.min(gray_mean + <span class="number">6</span> * gray_std, <span class="number">255</span>);</span><br><span class="line">    setMinAndMax(minGray, maxGray); <span class="comment">// 应用对比度设置</span></span><br><span class="line">    run(<span class="string">&quot;Apply LUT&quot;</span>); <span class="comment">// 应用色彩映射表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="荧光图像的处理-1"><a href="#荧光图像的处理-1" class="headerlink" title="荧光图像的处理"></a>荧光图像的处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">process_red</span><span class="params">(redTitle)</span> &#123;</span><br><span class="line">    selectWindow(redTitle); <span class="comment">// 选择red图像窗口</span></span><br><span class="line">    run(<span class="string">&quot;Split Channels&quot;</span>); <span class="comment">// 分离颜色通道</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义各颜色通道的窗口名称</span></span><br><span class="line">    redChan = redTitle + <span class="string">&quot; (red)&quot;</span>;</span><br><span class="line">    greenChan = redTitle + <span class="string">&quot; (green)&quot;</span>;</span><br><span class="line">    blueChan = redTitle + <span class="string">&quot; (blue)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭不需要的颜色通道（green和blue）</span></span><br><span class="line">    selectWindow(greenChan);</span><br><span class="line">    close();</span><br><span class="line">    selectWindow(blueChan);</span><br><span class="line">    close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理red通道图像</span></span><br><span class="line">    selectWindow(redChan);</span><br><span class="line">    run(<span class="string">&quot;8-bit&quot;</span>); <span class="comment">// 转换为8位图像</span></span><br><span class="line">    <span class="comment">// 设置测量参数，主要统计平均值和标准差，用与框选亮度和对比度范围</span></span><br><span class="line">    run(<span class="string">&quot;Set Measurements...&quot;</span>, <span class="string">&quot;mean standard redirect=None decimal=3&quot;</span>);</span><br><span class="line">    run(<span class="string">&quot;Measure&quot;</span>); <span class="comment">// 测量图像统计信息</span></span><br><span class="line">    red_mean = getResult(<span class="string">&quot;Mean&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取平均值</span></span><br><span class="line">    red_std = getResult(<span class="string">&quot;StdDev&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取标准差</span></span><br><span class="line">    <span class="comment">// 计算red图像的显示范围（均值 -0.2 个标准差到 +3 个标准差之间）</span></span><br><span class="line">    minRed = Math.max(red_mean - <span class="number">0.2</span> * red_std, <span class="number">0</span>);</span><br><span class="line">    maxRed = Math.min(red_mean + <span class="number">3</span> * red_std, <span class="number">255</span>);</span><br><span class="line">    setMinAndMax(minRed, maxRed); <span class="comment">// 应用对比度设置</span></span><br><span class="line">    run(<span class="string">&quot;Apply LUT&quot;</span>); <span class="comment">// 应用色彩映射表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redChan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="合并图像-1"><a href="#合并图像-1" class="headerlink" title="合并图像"></a>合并图像</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">merge_images</span><span class="params">(grayTitle, redChan)</span> &#123;</span><br><span class="line">    selectWindow(grayTitle);</span><br><span class="line">    selectWindow(redChan);</span><br><span class="line">    <span class="comment">// 将明场和荧光图像设置到相应的通道上，keep 表示保留原始图像</span></span><br><span class="line">    run(<span class="string">&quot;Merge Channels...&quot;</span>, <span class="string">&quot;red=[&quot;</span>+redChan+<span class="string">&quot;] gray=[&quot;</span>+grayTitle+<span class="string">&quot;] create keep&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置合并图像为RGB彩色模式并保存</span></span><br><span class="line">    selectWindow(<span class="string">&quot;Composite&quot;</span>);</span><br><span class="line">    run(<span class="string">&quot;RGB Color&quot;</span>);</span><br><span class="line">    saveAs(<span class="string">&quot;tif&quot;</span>, saveDir + baseName + <span class="string">&quot;_merged&quot;</span>);</span><br><span class="line">    close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文件交互与批量处理"><a href="#文件交互与批量处理" class="headerlink" title="文件交互与批量处理"></a>文件交互与批量处理</h3><p>最后我们需要在外部建立一个用于文件交互和循环批量处理的框架：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">macro <span class="string">&quot;Fluorescence Merge Gray And Red&quot;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取用户选择的源目录路径</span></span><br><span class="line">    dir = getDirectory(<span class="string">&quot;Choose source directory containing *_gray.tif and *_red.tif files&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="string">&quot;&quot;</span>) exit(); <span class="comment">// 如果未选择目录则退出程序</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义输出目录路径</span></span><br><span class="line">    saveDir = dir + <span class="string">&quot;/../merged/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查并创建输出目录</span></span><br><span class="line">    <span class="keyword">if</span> (!File.exists(saveDir)) &#123;</span><br><span class="line">        File.makeDirectory(saveDir)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取目录中所有文件列表及数量</span></span><br><span class="line">    list = getFileList(dir);</span><br><span class="line">    n = lengthOf(list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有文件，只处理以 _gray.tif 结尾的文件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        filename = list[i];</span><br><span class="line">        <span class="keyword">if</span> (!endsWith(filename, <span class="string">&quot;_gray.tif&quot;</span>)) <span class="keyword">continue</span>; <span class="comment">// 跳过非_gray.tif文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取基础文件名（不含&quot;_gray.tif&quot;后缀）</span></span><br><span class="line">        baseName = substring(filename, <span class="number">0</span>, lengthOf(filename) - <span class="number">9</span>);</span><br><span class="line">        <span class="comment">// 构建gray和red图像的完整路径</span></span><br><span class="line">        grayPath = dir + filename;</span><br><span class="line">        redPath = dir + baseName + <span class="string">&quot;_red.tif&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查对应的red图像是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (!File.exists(redPath)) &#123;</span><br><span class="line">            print(<span class="string">&quot;跳过: 找不到对应的 red 文件: &quot;</span> + redPath);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打开gray和red图像</span></span><br><span class="line">        open(grayPath);</span><br><span class="line">        open(redPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前打开的所有图像窗口标题</span></span><br><span class="line">        titles = getList(<span class="string">&quot;image.titles&quot;</span>);</span><br><span class="line">        grayTitle = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redTitle = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从窗口标题中区分gray和red图像</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; lengthOf(titles); j++) &#123;</span><br><span class="line">            t = titles[j];</span><br><span class="line">            <span class="keyword">if</span> (indexOf(t, <span class="string">&quot;_gray.tif&quot;</span>) &gt;= <span class="number">0</span>) grayTitle = t;</span><br><span class="line">            <span class="keyword">if</span> (indexOf(t, <span class="string">&quot;_red.tif&quot;</span>) &gt;= <span class="number">0</span>) redTitle = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证是否成功识别了两个图像</span></span><br><span class="line">        <span class="keyword">if</span> (grayTitle == <span class="string">&quot;&quot;</span> || redTitle == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            print(<span class="string">&quot;警告: 无法识别 gray 或 red 图像，跳过: &quot;</span> + baseName);</span><br><span class="line">            close(<span class="string">&quot;*&quot;</span>); <span class="comment">// 关闭所有刚打开的图像</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 处理 gray 通道图像 ===</span></span><br><span class="line">        process_gray(grayTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 处理 red 通道图像 ===</span></span><br><span class="line">        redChan = process_red(redTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 合并图像 ===</span></span><br><span class="line">        merge_images(grayTitle, redChan);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空结果表，避免累积数据</span></span><br><span class="line">        run(<span class="string">&quot;Clear Results&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存处理后的gray通道图像</span></span><br><span class="line">        selectWindow(grayTitle);</span><br><span class="line">        saveAs(<span class="string">&quot;tif&quot;</span>, saveDir + baseName + <span class="string">&quot;_gray_processed&quot;</span>);</span><br><span class="line">        close(grayTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置red通道为红色显示并保存</span></span><br><span class="line">        selectWindow(redChan);</span><br><span class="line">        run(<span class="string">&quot;Red&quot;</span>); <span class="comment">// 应用红色LUT</span></span><br><span class="line">        run(<span class="string">&quot;RGB Color&quot;</span>); <span class="comment">// 转换为RGB模式</span></span><br><span class="line">        saveAs(<span class="string">&quot;tif&quot;</span>, saveDir + baseName + <span class="string">&quot;_red_processed&quot;</span>);   </span><br><span class="line">        close(redChan); </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭所有剩余窗口</span></span><br><span class="line">        close(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输出完成信息</span></span><br><span class="line">    print(<span class="string">&quot;批量处理完成！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>重要的事情说三遍：</p><p><strong>一定要认真阅读代码中我标了 <code>！！！</code> 的部分，需要自行根据实验需要修改</strong><br><strong>一定要认真阅读代码中我标了 <code>！！！</code> 的部分，需要自行根据实验需要修改</strong><br><strong>一定要认真阅读代码中我标了 <code>！！！</code> 的部分，需要自行根据实验需要修改</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量合并荧光图像的ImageJ宏脚本</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 功能说明：</span></span><br><span class="line"><span class="comment"> * 1. 自动搜索指定目录中的*_gray.tif和*_red.tif图像对</span></span><br><span class="line"><span class="comment"> * 2. 对每个图像对执行标准化处理和对比度调整</span></span><br><span class="line"><span class="comment"> * 3. 将gray图像作为灰度通道，red图像作为红色通道进行合并</span></span><br><span class="line"><span class="comment"> * 4. 输出合并后的彩色图像以及单独处理后的通道图像</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 使用方法：</span></span><br><span class="line"><span class="comment"> * 0. ！！！如果你的通道不是红色的，比如是绿色的，那你就把代码里所有的 red 都改成 green，相应地，所有的 green 也都改成 red！！！</span></span><br><span class="line"><span class="comment"> * 1. 运行此宏脚本</span></span><br><span class="line"><span class="comment"> * 2. 选择包含*_gray.tif和*_red.tif文件的源目录</span></span><br><span class="line"><span class="comment"> * 3. 脚本将在上一级目录创建&quot;merged&quot;文件夹保存输出结果</span></span><br><span class="line"><span class="comment"> * 4. 注意看我标了 ！！！ 的地方，可以自行修改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">macro <span class="string">&quot;Fluorescence Merge Gray And Red&quot;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取用户选择的源目录路径</span></span><br><span class="line">    dir = getDirectory(<span class="string">&quot;Choose source directory containing *_gray.tif and *_red.tif files&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="string">&quot;&quot;</span>) exit(); <span class="comment">// 如果未选择目录则退出程序</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义输出目录路径</span></span><br><span class="line">    saveDir = dir + <span class="string">&quot;/../merged/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查并创建输出目录</span></span><br><span class="line">    <span class="keyword">if</span> (!File.exists(saveDir)) &#123;</span><br><span class="line">        File.makeDirectory(saveDir)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取目录中所有文件列表及数量</span></span><br><span class="line">    list = getFileList(dir);</span><br><span class="line">    n = lengthOf(list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有文件，只处理以 _gray.tif 结尾的文件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        filename = list[i];</span><br><span class="line">        <span class="keyword">if</span> (!endsWith(filename, <span class="string">&quot;_gray.tif&quot;</span>)) <span class="keyword">continue</span>; <span class="comment">// 跳过非_gray.tif文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取基础文件名（不含&quot;_gray.tif&quot;后缀）</span></span><br><span class="line">        baseName = substring(filename, <span class="number">0</span>, lengthOf(filename) - <span class="number">9</span>);</span><br><span class="line">        <span class="comment">// 构建gray和red图像的完整路径</span></span><br><span class="line">        grayPath = dir + filename;</span><br><span class="line">        redPath = dir + baseName + <span class="string">&quot;_red.tif&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查对应的red图像是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (!File.exists(redPath)) &#123;</span><br><span class="line">            print(<span class="string">&quot;跳过: 找不到对应的 red 文件: &quot;</span> + redPath);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打开gray和red图像</span></span><br><span class="line">        open(grayPath);</span><br><span class="line">        open(redPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前打开的所有图像窗口标题</span></span><br><span class="line">        titles = getList(<span class="string">&quot;image.titles&quot;</span>);</span><br><span class="line">        grayTitle = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redTitle = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从窗口标题中区分gray和red图像</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; lengthOf(titles); j++) &#123;</span><br><span class="line">            t = titles[j];</span><br><span class="line">            <span class="keyword">if</span> (indexOf(t, <span class="string">&quot;_gray.tif&quot;</span>) &gt;= <span class="number">0</span>) grayTitle = t;</span><br><span class="line">            <span class="keyword">if</span> (indexOf(t, <span class="string">&quot;_red.tif&quot;</span>) &gt;= <span class="number">0</span>) redTitle = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证是否成功识别了两个图像</span></span><br><span class="line">        <span class="keyword">if</span> (grayTitle == <span class="string">&quot;&quot;</span> || redTitle == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            print(<span class="string">&quot;警告: 无法识别 gray 或 red 图像，跳过: &quot;</span> + baseName);</span><br><span class="line">            close(<span class="string">&quot;*&quot;</span>); <span class="comment">// 关闭所有刚打开的图像</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 处理 gray 通道图像 ===</span></span><br><span class="line">        process_gray(grayTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 处理 red 通道图像 ===</span></span><br><span class="line">        redChan = process_red(redTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// === 合并图像 ===</span></span><br><span class="line">        merge_images(grayTitle, redChan);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空结果表，避免累积数据</span></span><br><span class="line">        run(<span class="string">&quot;Clear Results&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存处理后的gray通道图像</span></span><br><span class="line">        selectWindow(grayTitle);</span><br><span class="line">        saveAs(<span class="string">&quot;tif&quot;</span>, saveDir + baseName + <span class="string">&quot;_gray_processed&quot;</span>);</span><br><span class="line">        close(grayTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置red通道为红色显示并保存</span></span><br><span class="line">        selectWindow(redChan);</span><br><span class="line">        run(<span class="string">&quot;Red&quot;</span>); <span class="comment">// 应用红色LUT</span></span><br><span class="line">        run(<span class="string">&quot;RGB Color&quot;</span>); <span class="comment">// 转换为RGB模式</span></span><br><span class="line">        saveAs(<span class="string">&quot;tif&quot;</span>, saveDir + baseName + <span class="string">&quot;_red_processed&quot;</span>);   </span><br><span class="line">        close(redChan); </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭所有剩余窗口</span></span><br><span class="line">        close(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输出完成信息</span></span><br><span class="line">    print(<span class="string">&quot;批量处理完成！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function <span class="title function_">process_gray</span><span class="params">(grayTitle)</span> &#123;</span><br><span class="line">    selectWindow(grayTitle); <span class="comment">// 选择gray图像窗口</span></span><br><span class="line">    run(<span class="string">&quot;8-bit&quot;</span>); <span class="comment">// 转换为8位图像</span></span><br><span class="line">    run(<span class="string">&quot;Set Measurements...&quot;</span>, <span class="string">&quot;mean standard redirect=None decimal=3&quot;</span>); <span class="comment">// 设置测量参数</span></span><br><span class="line">    run(<span class="string">&quot;Measure&quot;</span>); <span class="comment">// 测量图像统计信息</span></span><br><span class="line">    gray_mean = getResult(<span class="string">&quot;Mean&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取平均灰度值</span></span><br><span class="line">    gray_std = getResult(<span class="string">&quot;StdDev&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取灰度标准差</span></span><br><span class="line">    <span class="comment">// 计算gray图像的显示范围（均值 -2 个标准差到 +6 个标准差之间）</span></span><br><span class="line">    <span class="comment">// ！！！这个标准差范围是我尝试出来比较合适的，大家也可以自己多试几次，找到适合自己实验的数值！！！</span></span><br><span class="line">    minGray = Math.max(gray_mean - <span class="number">2</span> * gray_std, <span class="number">0</span>);</span><br><span class="line">    maxGray = Math.min(gray_mean + <span class="number">6</span> * gray_std, <span class="number">255</span>);</span><br><span class="line">    setMinAndMax(minGray, maxGray); <span class="comment">// 应用对比度设置</span></span><br><span class="line">    run(<span class="string">&quot;Apply LUT&quot;</span>); <span class="comment">// 应用色彩映射表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function <span class="title function_">process_red</span><span class="params">(redTitle)</span> &#123;</span><br><span class="line">    selectWindow(redTitle); <span class="comment">// 选择red图像窗口</span></span><br><span class="line">    run(<span class="string">&quot;Split Channels&quot;</span>); <span class="comment">// 分离颜色通道</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义各颜色通道的窗口名称</span></span><br><span class="line">    redChan = redTitle + <span class="string">&quot; (red)&quot;</span>;</span><br><span class="line">    greenChan = redTitle + <span class="string">&quot; (green)&quot;</span>;</span><br><span class="line">    blueChan = redTitle + <span class="string">&quot; (blue)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭不需要的颜色通道（green和blue）</span></span><br><span class="line">    <span class="comment">// ！！！如果需要蓝色通道就关闭红色和绿色，如果需要绿色通道就关闭红色和蓝色，记得自己改！！！</span></span><br><span class="line">    selectWindow(greenChan);</span><br><span class="line">    close();</span><br><span class="line">    selectWindow(blueChan);</span><br><span class="line">    close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理red通道图像</span></span><br><span class="line">    selectWindow(redChan);</span><br><span class="line">    run(<span class="string">&quot;8-bit&quot;</span>); <span class="comment">// 转换为8位图像</span></span><br><span class="line">    <span class="comment">// 设置测量参数，主要统计平均值和标准差，用与框选亮度和对比度范围</span></span><br><span class="line">    run(<span class="string">&quot;Set Measurements...&quot;</span>, <span class="string">&quot;mean standard redirect=None decimal=3&quot;</span>);</span><br><span class="line">    run(<span class="string">&quot;Measure&quot;</span>); <span class="comment">// 测量图像统计信息</span></span><br><span class="line">    red_mean = getResult(<span class="string">&quot;Mean&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取平均值</span></span><br><span class="line">    red_std = getResult(<span class="string">&quot;StdDev&quot;</span>, nResults - <span class="number">1</span>); <span class="comment">// 获取标准差</span></span><br><span class="line">    <span class="comment">// 计算red图像的显示范围（均值 -0.2 个标准差到 +3 个标准差之间）</span></span><br><span class="line">    <span class="comment">// ！！！这个标准差范围是我尝试出来比较合适的，大家也可以自己多试几次，找到适合自己实验的数值！！！</span></span><br><span class="line">    minRed = Math.max(red_mean - <span class="number">0.2</span> * red_std, <span class="number">0</span>);</span><br><span class="line">    maxRed = Math.min(red_mean + <span class="number">3</span> * red_std, <span class="number">255</span>);</span><br><span class="line">    setMinAndMax(minRed, maxRed); <span class="comment">// 应用对比度设置</span></span><br><span class="line">    run(<span class="string">&quot;Apply LUT&quot;</span>); <span class="comment">// 应用色彩映射表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redChan;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function <span class="title function_">merge_images</span><span class="params">(grayTitle, redChan)</span> &#123;</span><br><span class="line">    selectWindow(grayTitle);</span><br><span class="line">    selectWindow(redChan);</span><br><span class="line">    <span class="comment">// 将明场和荧光图像设置到相应的通道上，keep 表示保留原始图像</span></span><br><span class="line">    <span class="comment">// ！！！如果你需要更多通道，可以继续在后面按相同格式添加！！！</span></span><br><span class="line">    run(<span class="string">&quot;Merge Channels...&quot;</span>, <span class="string">&quot;red=[&quot;</span>+redChan+<span class="string">&quot;] gray=[&quot;</span>+grayTitle+<span class="string">&quot;] create keep&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置合并图像为RGB彩色模式并保存</span></span><br><span class="line">    selectWindow(<span class="string">&quot;Composite&quot;</span>);</span><br><span class="line">    run(<span class="string">&quot;RGB Color&quot;</span>);</span><br><span class="line">    saveAs(<span class="string">&quot;tif&quot;</span>, saveDir + baseName + <span class="string">&quot;_merged&quot;</span>);</span><br><span class="line">    close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用方法（必看）"><a href="#使用方法（必看）" class="headerlink" title="使用方法（必看）"></a>使用方法（必看）</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ol><li>在 ImageJ 中打开 Plugins -&gt; Macros -&gt; Startup Macros；</li></ol><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/14_menu_startup_macros.png"></p><ol start="2"><li>在弹出的窗口的最后，粘贴入上面复制的完整代码；</li></ol><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/15_startup_macros.png"></p><ol start="3"><li>保存并关闭窗口，重启软件，之后应该会看到在 Plugin -&gt; Macros -&gt; Fluorescence Merge Gray And Red，这就是我们刚刚安装的宏命令，点击就可以立即执行。</li></ol><p><img src="/2026/01/29/%E4%BD%BF%E7%94%A8ImageJ%E6%89%B9%E9%87%8F%E5%90%88%E5%B9%B6%E7%BB%86%E8%83%9E%E8%8D%A7%E5%85%89%E5%9B%BE%E5%83%8F/16_fluorescence_merge_gray_and_red.png"></p><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ol><li>首先我们要创建两个同级别的文件夹，取名 <code>raw</code> 和 <code>merged</code>，前者用于存放原始的细胞图片，后者用于存放处理后的细胞图片；</li><li>将原始图片放入 <code>raw</code> 文件夹中，注意对应的灰度和荧光图片的文件名前面必须一致，后面必须分别以 <code>_gray.tif</code> 和 <code>_red.tif</code> 结尾，例如 <code>cell_1_gray.tif</code> 和 <code>cell_1_red.tif</code>，当然如果你的荧光是绿色的那你就命名为<code>_green.tif</code>，以此类推；</li><li><strong>一定要认真阅读代码块里面我标了 <code>！！！</code> 的部分，根据自己实验的参数进行修改</strong>；</li><li>运行脚本，脚本会弹出一个对话框，选择 <code>raw</code> 文件夹；</li><li>脚本会自动运行，运行结束后会在 <code>merged</code> 文件夹中生成处理后的图片，文件名分别为 <code>cell_1_gray_processed.tif</code>、<code>cell_1_red_processed.tif</code> 和 <code>cell_1_merged.tif</code>。</li></ol><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>本文给出的是一种处理普通图片格式比如 tif、jpg、png 等的方法，如果你的实验够高大上，是用比方说蔡司的系统采的图，那就完全可以用相应的 Zen 软件进行处理。</p>]]></content>
      
      
      <categories>
          
          <category> 实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绘图 </tag>
            
            <tag> 图像处理 </tag>
            
            <tag> ImageJ </tag>
            
            <tag> 细胞荧光 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ggplot2 完全解析 EP.01 从 0 到 1</title>
      <link href="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/"/>
      <url>/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/</url>
      
        <content type="html"><![CDATA[<h1 id="ggplot2-完全解析-EP-01-从-0-到-1"><a href="#ggplot2-完全解析-EP-01-从-0-到-1" class="headerlink" title="ggplot2 完全解析 EP.01 从 0 到 1"></a>ggplot2 完全解析 EP.01 从 0 到 1</h1><h2 id="视频教程"><a href="#视频教程" class="headerlink" title="视频教程"></a>视频教程</h2><div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%;"><iframe src="//player.bilibili.com/player.html?isOutside=true&aid=113486021594973&bvid=BV17QmoYHEU9&cid=26770738940&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left:0; top: 0"></iframe></div><h2 id="内容简介"><a href="#内容简介" class="headerlink" title="内容简介"></a>内容简介</h2><ol><li>ggplot2 中会使用到的基本元件</li><li>使用 ggplot2 需要了解的基本概念</li><li>不同种类元件的具体用法浅析</li><li>实例解析 - 小提琴箱线散点图</li></ol><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>科研成果的呈现绘图是必不可少的，支持科研图标绘制的工具有很多，比如可视化操作下的 Graphpad Prism、Origin 等等，或者 Python 中的 matplotlib、seaborn、plotly 等等，这些工具我平常也都会用到，主要根据具体环境选择，但是说到生信分析当中的可视化，我还是唯独钟爱 ggplot2，它的简介性、语法一致性、结构完整性、可拓展性都是别的绘图系统不能比的，所以在此开一个坑介绍一下它的各种实际用法。</p><p>在讲到具体的各种奇技淫巧之前，还是需要这样一个总起性的章节对这个好用、易用、实用的绘图系统有一个基本的了解</p><h2 id="ggplot2-中会使用到的基本元件"><a href="#ggplot2-中会使用到的基本元件" class="headerlink" title="ggplot2 中会使用到的基本元件"></a>ggplot2 中会使用到的基本元件</h2><ol><li>geom 类：geom 是 geometry 的缩写，函数的格式类似 <code>geom_point()</code>&#x2F;<code>geom_line()</code>&#x2F;<code>geom_*()</code> 等等，主要负责使用原始数据直接绘制各种图形，是一张图标中最主要的部分；</li><li>stat 类: stat 是 statistics 的缩写，函数的格式类似 <code>stat_smooth()</code>&#x2F;<code>stat_qq()</code>&#x2F;<code>stat_*()</code> 等等，负责对原始数据进行统计处理，比如 <code>stat_smooth()</code> 函数会根据原始数据进行回归分析，并返回预测值，<code>stat_qq()</code> 函数会根据原始数据进行 QQ 检验，并返回结果，是在原始数据的基础上进一步进行统计描述；</li><li><code>annotate()</code> 函数：标注函数，用于在图片上添加自定义注释，比如强调某个点；</li><li>scale 类： 函数的格式类似 <code>scale_x_continuous()</code>&#x2F;<code>scale_y_discrete()</code>&#x2F;<code>scale_*()</code> 等等，负责调整坐标轴、颜色、尺寸、透明度等各种标尺的映射，适当的使用可以使图片更美观或者使需要强调的内容更突出；</li><li>各种主题相关函数：如 theme 类、coord 类、facet 类、guide 类等等，还有 <code>ggtitle()</code>&#x2F;<code>labs()</code> 这些散在的函数，负责调整图片的样式，比如主题风格、坐标轴比例、 分面等等，这些函数的格式类似 <code>theme_classic()</code>&#x2F;<code>coord_polar()</code>&#x2F;<code>facet_grid()</code>&#x2F;<code>guide_legend()</code> 等等，主要影响图片的美术风格和展示样式，本文主要只对 theme 类稍作展开。</li></ol><p>对于 geom 类、stat 类、scale 类，我统称为图形类，因为他们都构成了主图的图形，scale 类我又称为标尺类。对于一张完整的图，图形类的元素是<strong>必不可少</strong>的，而标尺类与主题类都是锦上添花，而一张完整的图片，就是由这些基本元素排列组合而成的。</p><h2 id="ggplot2-的基本概念"><a href="#ggplot2-的基本概念" class="headerlink" title="ggplot2 的基本概念"></a>ggplot2 的基本概念</h2><h3 id="代码块的基本构成"><a href="#代码块的基本构成" class="headerlink" title="代码块的基本构成"></a>代码块的基本构成</h3><p>首先，我们通常看到的代码块，由各个元件通过 <code>+</code> 号连接构成，比如：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 遵循 tidyverse 推荐格式</span></span><br><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span>      <span class="comment"># 头部，必须存在，声明一个图形的启动</span></span><br><span class="line">    geom_<span class="operator">*</span><span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span>      <span class="comment"># 图形类中的三种元素至少要出现一个，否则就是空白图</span></span><br><span class="line">    stat_<span class="operator">*</span><span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    annotate<span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span>    </span><br><span class="line">    scale_<span class="operator">*</span><span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span>     <span class="comment"># 下列各种标尺类和主题类都非必须，但是如果真的都不放，图片会很丑</span></span><br><span class="line">    ggtitle<span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    labs<span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    theme_<span class="operator">*</span><span class="punctuation">(</span>...<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>很有趣的一点是，ggplot2 在 python 中也得到了几乎完全的移植，如 plotnine，在 python 中，格式略有不同，但是我因为对齐清爽更喜欢这种格式，在 R 语言中也常照搬如下格式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">panel = (</span><br><span class="line">    ggplot(...)</span><br><span class="line">    + geom_*(...)</span><br><span class="line">    + stat_*(...)</span><br><span class="line">    + annotate(...)</span><br><span class="line">    + scale_*(...)</span><br><span class="line">    + ggtitle(...)</span><br><span class="line">    + labs(...)</span><br><span class="line">    + theme_*(...)</span><br><span class="line">    + ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="输入数据的格式"><a href="#输入数据的格式" class="headerlink" title="输入数据的格式"></a>输入数据的格式</h2><p>ggplot2 的输入数据必须是 <code>data.frame</code> 格式，当然，作为 tidyverse 家族的一员，<code>tibble</code> 这种更严格的 <code>data.frame</code> 也是兼容的。</p><p>对于 <code>data.frame</code> 这一类表格数据，通常有长表与宽表之分：</p><p><strong>长表</strong>是指表格的每一行是一个样本，而每一列代表了样本的一个属性，比如：</p><table><thead><tr><th>id</th><th>颜色</th><th>大小</th><th>名称</th></tr></thead><tbody><tr><td>1</td><td>红</td><td>大</td><td>苹果</td></tr><tr><td>2</td><td>红</td><td>小</td><td>樱桃</td></tr><tr><td>3</td><td>紫</td><td>大</td><td>山竹</td></tr><tr><td>4</td><td>紫</td><td>小</td><td>葡萄</td></tr></tbody></table><p>而<strong>宽表</strong>内的每一个数据都是一个样本，行名和列名用来定位属性，比如：</p><table><thead><tr><th>大小\颜色</th><th>红</th><th>紫</th></tr></thead><tbody><tr><td>大</td><td>苹果</td><td>山竹</td></tr><tr><td>小</td><td>樱桃</td><td>葡萄</td></tr></tbody></table><p>在 ggplot2 中，必须使用长表数据，如果你手上的数据是宽表数据也不用担心，有很多种方法可以转换为长表数据，比如 reshape2 包中的 <code>melt()</code> 函数，或者用 tidyr 包中的 <code>pivot_longer()</code> 函数，当然，后者作为 tidyverse 分析流程中的一员，是更为推荐的。</p><p>比如我们通过大小为横坐标，颜色为纵坐标，可以把四种水果的标签标记在相应的象限上：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> fruit<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x     <span class="operator">=</span> `大小`<span class="punctuation">,</span></span><br><span class="line">            y     <span class="operator">=</span> `颜色`<span class="punctuation">,</span></span><br><span class="line">            label <span class="operator">=</span> `名称`</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_text<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">panel</span><br></pre></td></tr></table></figure><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/1_fruit.png"></p><h2 id="全局数据与局部数据"><a href="#全局数据与局部数据" class="headerlink" title="全局数据与局部数据"></a>全局数据与局部数据</h2><p>我们来观察如下两个代码块</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> dat<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x     <span class="operator">=</span> x<span class="punctuation">,</span></span><br><span class="line">            y     <span class="operator">=</span> y<span class="punctuation">,</span></span><br><span class="line">            label <span class="operator">=</span> label</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_text<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_point<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> dat1<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x <span class="operator">=</span> x1<span class="punctuation">,</span></span><br><span class="line">            y <span class="operator">=</span> y1</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_text<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> dat2<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x <span class="operator">=</span> x2<span class="punctuation">,</span></span><br><span class="line">            y <span class="operator">=</span> y2<span class="punctuation">,</span></span><br><span class="line">            label <span class="operator">=</span> label</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>在第一个代码块中，所有的数据包括标尺数据都写在 <code>ggplot()</code> 函数中，这代表着之后跟着的所有绘图元素，比如 <code>geom_point()</code>、<code>geom_text()</code>，都会使用 <code>dat</code> 这个数据集进行绘图，我们称为全局数据；在第二个代码块中，数据集 <code>dat1</code> 和 <code>dat2</code> 分别被 <code>geom_point()</code> 和 <code>geom_text()</code> 函数所使用，两种图形依据不同的数据绘制，互不干扰，这被称为局部数据。</p><p>大部分情况下，主图中的内容都写在全局数据中，但是对于一些特殊的标注，就会用到局部数据，比如我们绘制差异基因火山图时，全局数据用于绘制所有基因的散点图，但是对于我们关注的基因，我们就会用局部数据绘制几个单独的点：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">panel_volcano <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> deg<span class="punctuation">,</span>                 <span class="comment"># 全局数据，包含了所有基因</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x     <span class="operator">=</span> log2FoldChange<span class="punctuation">,</span></span><br><span class="line">            y     <span class="operator">=</span> <span class="operator">-</span>log10<span class="punctuation">(</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            color <span class="operator">=</span> regulation</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span>                     <span class="comment"># 继承自全局数据，绘制所有基因</span></span><br><span class="line">    geom_point<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> deg_highlight<span class="punctuation">,</span>       <span class="comment"># 添加单独的局部变量，高亮关注的基因</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x     <span class="operator">=</span> log2FoldChange<span class="punctuation">,</span></span><br><span class="line">            y     <span class="operator">=</span> <span class="operator">-</span>log10<span class="punctuation">(</span>pvalue<span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        color   <span class="operator">=</span> <span class="string">&quot;black&quot;</span>              <span class="comment"># 改变这些高亮点的颜色做出区分</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">panel_volcano</span><br></pre></td></tr></table></figure><p>如果只使用全局变量，结果就如下图：</p><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/2_global.png"></p><p>而因为我们添加了局部变量，所以有标记我们关注的基因，如下图：</p><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/3_local.png"></p><h3 id="变量属性与常量属性"><a href="#变量属性与常量属性" class="headerlink" title="变量属性与常量属性"></a>变量属性与常量属性</h3><p>我们再观察如下的代码块与对应的图片：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> fruit<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x     <span class="operator">=</span> `大小`<span class="punctuation">,</span></span><br><span class="line">            y     <span class="operator">=</span> `颜色`<span class="punctuation">,</span></span><br><span class="line">            label <span class="operator">=</span> `名称`<span class="punctuation">,</span></span><br><span class="line">            color <span class="operator">=</span> `名称`</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_text<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/4_variable.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> fruit<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x     <span class="operator">=</span> `大小`<span class="punctuation">,</span></span><br><span class="line">            y     <span class="operator">=</span> `颜色`<span class="punctuation">,</span></span><br><span class="line">            label <span class="operator">=</span> `名称`</span><br><span class="line">        <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        color   <span class="operator">=</span> <span class="string">&quot;red&quot;</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_text<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/5_constant.png"></p><p>两段代码中，只有 <code>color</code> 属性的位置和值不同，前者 <code>color</code> 放在<code>aes()</code> 内部，基于水果的名称分配绘图颜色，所以每种水果的绘图颜色不同，因而称为变量属性；后者 <code>color</code> 放在 <code>aes()</code> 之外，基于常量值 <code>&quot;red&quot;</code>，所以所有水果的绘图颜色都是红色，为常量属性。</p><p>变量属性的作用是基于样本的不同属性为绘图元素分配不同外观，比如在通路富集气泡图中根据 p 值的大小分配颜色、根据基因的个数分配点的大小，等等；而常量属性的作用是统一规定图形的外观，比如把图中所有文字的大小都规定为 4。</p><p>变量属性与常量属性的区别只在于是否在 <code>aes()</code> 内，切不要与全局数据和局部数据混淆了。</p><h3 id="图层"><a href="#图层" class="headerlink" title="图层"></a>图层</h3><p>最后我们观察这一对代码块：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> mtcars<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x <span class="operator">=</span> factor<span class="punctuation">(</span>gear<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            y <span class="operator">=</span> mpg</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_boxplot<span class="punctuation">(</span></span><br><span class="line">        fill <span class="operator">=</span> <span class="string">&#x27;red&#x27;</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_violin<span class="punctuation">(</span></span><br><span class="line">        fill <span class="operator">=</span> <span class="string">&#x27;blue&#x27;</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">panel</span><br></pre></td></tr></table></figure><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/6_violin.png"></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> mtcars<span class="punctuation">,</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x <span class="operator">=</span> factor<span class="punctuation">(</span>gear<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            y <span class="operator">=</span> mpg</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_violin<span class="punctuation">(</span></span><br><span class="line">        fill <span class="operator">=</span> <span class="string">&#x27;blue&#x27;</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_boxplot<span class="punctuation">(</span></span><br><span class="line">        fill <span class="operator">=</span> <span class="string">&#x27;red&#x27;</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">panel</span><br></pre></td></tr></table></figure><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/7_boxplot.png"></p><p>两个示例中，<code>boxplot</code> 与 <code>violin</code> 的顺序不同，因而输出的图片中两种图形覆盖的顺序不同，总而言之，靠后的代码绘制的图形会覆盖靠前的代码绘制的图形。</p><h2 id="不同种类元件的具体用法浅析"><a href="#不同种类元件的具体用法浅析" class="headerlink" title="不同种类元件的具体用法浅析"></a>不同种类元件的具体用法浅析</h2><h3 id="图形类"><a href="#图形类" class="headerlink" title="图形类"></a>图形类</h3><p>以 <code>geom_point()</code> 为例，主要的属性有：</p><ol><li><code>x, y</code>：位置；</li><li><code>color</code>：颜色，若为实心形状则为整体颜色，若为空心图形则为边缘颜色；</li><li><code>fill</code>：填充颜色，只在空心图形中有效；</li><li><code>shape</code>：形状，常用的如 0 为 ■，1 为 ●，22为 □，21 为 ○，等等；</li><li><code>size</code>：大小；</li><li><code>alpha</code>：透明度，取值范围 0-1，0 表示完全透明，1 表示完全不透明。</li></ol><p>这些属性都可用作变量属性或作常量属性。</p><h3 id="标尺类"><a href="#标尺类" class="headerlink" title="标尺类"></a>标尺类</h3><p>以 <code>scale_color_manual</code> 为例，主要的属性有：</p><ol><li><code>name</code>：名称，显示在图例中，说明颜色标注的是哪个属性；</li><li><code>breaks</code>：刻度，与 <code>values</code> 对应；</li><li><code>values</code>：颜色，与 <code>breaks</code> 对应，规定具体的颜色，比如 <code>breaks = c(&quot;苹果&quot;， &quot;梨&quot;), values = c(&quot;red&quot;, &quot;blue&quot;)</code>，那么苹果的颜色就是红色，梨的颜色就是蓝色；</li><li><code>labels</code>：标签，与 <code>breaks</code> 对应，比如 <code>breaks = c(&quot;苹果&quot;， &quot;梨&quot;), labels = c(&quot;apple&quot;， &quot;pear&quot;)</code>，那么苹果对应的标签就是 apple，梨对应的标签就是 pear。</li></ol><p>不同的 <code>scale_*()</code> 函数的具体属性差异巨大，具体还要查阅文档。</p><h3 id="主题类"><a href="#主题类" class="headerlink" title="主题类"></a>主题类</h3><p>1、 theme 类：ggplot2 提供了各种预设的主题，比如 <code>theme_classic()</code>、<code>theme_bw()</code>、<code>theme_minimal()</code>、<code>theme_void()</code>、<code>theme_gray()</code> 等等，暂不展开自定义主题，以后聊到具体绘图的时候再讲解；<br>2. <code>labs()</code> 函数：为图形添加标题、图例、坐标轴标签等等，比如 <code>labs(title = &quot;标题&quot;, x = &quot;X 轴&quot;, y = &quot;Y 轴&quot;)</code>，等等；<br>3. <code>ggtitle()</code> 函数：另一种添加标题的方法，比如 <code>ggtitle(&quot;标题&quot;)</code>，如果不调整主题，默认显示在图片的左上角。</p><h2 id="实例解析-小提琴箱线散点图"><a href="#实例解析-小提琴箱线散点图" class="headerlink" title="实例解析 - 小提琴箱线散点图"></a>实例解析 - 小提琴箱线散点图</h2><p>话不多说，直接开画：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">panel <span class="operator">&lt;-</span></span><br><span class="line">    ggplot<span class="punctuation">(</span></span><br><span class="line">        data    <span class="operator">=</span> mtcars<span class="punctuation">,</span>         <span class="comment"># 全局数据</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            x <span class="operator">=</span> factor<span class="punctuation">(</span>gear<span class="punctuation">)</span><span class="punctuation">,</span>     <span class="comment"># 全局变量，规定横轴与纵轴基于的属性</span></span><br><span class="line">            y <span class="operator">=</span> mpg</span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_violin<span class="punctuation">(</span></span><br><span class="line">        mapping <span class="operator">=</span> aes<span class="punctuation">(</span></span><br><span class="line">            fill <span class="operator">=</span> factor<span class="punctuation">(</span>gear<span class="punctuation">)</span>   <span class="comment"># 局部变量，规定小提琴图的填充颜色基于 gear</span></span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_boxplot<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">)</span> <span class="operator">+</span>   <span class="comment"># 局部常量，规定箱线图的宽度为 0.2，避免遮挡小提琴图</span></span><br><span class="line">    geom_jitter<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">)</span> <span class="operator">+</span>    <span class="comment"># 局部常量，规定散点图的宽度为 0.2，避免超出箱线图范围</span></span><br><span class="line">    ggtitle<span class="punctuation">(</span>                      <span class="comment"># 添加标题</span></span><br><span class="line">        <span class="string">&quot;MPG ~ Gear&quot;</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    labs<span class="punctuation">(</span>                         <span class="comment"># 添加坐标轴与图例标签</span></span><br><span class="line">        x    <span class="operator">=</span> <span class="string">&quot;Gear&quot;</span><span class="punctuation">,</span></span><br><span class="line">        y    <span class="operator">=</span> <span class="string">&quot;MPG&quot;</span></span><br><span class="line">        fill <span class="operator">=</span> <span class="string">&quot;Gear&quot;</span></span><br><span class="line">    <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    theme_classic<span class="punctuation">(</span><span class="punctuation">)</span>               <span class="comment"># 使用经典主题</span></span><br><span class="line">panel</span><br></pre></td></tr></table></figure><p><img src="/2026/01/27/ggplot2%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90EP-01/8_violin_box_jitter.png"></p>]]></content>
      
      
      <categories>
          
          <category> 生信 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ggplot2 </tag>
            
            <tag> 绘图 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我目前做生信分析使用的文件树</title>
      <link href="/2026/01/26/%E6%88%91%E7%9B%AE%E5%89%8D%E5%81%9A%E7%94%9F%E4%BF%A1%E5%88%86%E6%9E%90%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6%E6%A0%91/"/>
      <url>/2026/01/26/%E6%88%91%E7%9B%AE%E5%89%8D%E5%81%9A%E7%94%9F%E4%BF%A1%E5%88%86%E6%9E%90%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h1 id="我目前做生信分析使用的文件树"><a href="#我目前做生信分析使用的文件树" class="headerlink" title="我目前做生信分析使用的文件树"></a>我目前做生信分析使用的文件树</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>做一个好的项目，好的文件结构必不可少，一个好的文件树可以保证阅读性、可复用性和可维护性。好在生信项目的流程很固定，所以文件树也不需要那么复杂。</p><p>通常一个生信项目会包含这些步骤：数据导入-数据分析-数据可视化-数据导出-结果分析。因此我构建的文件树格式也大致如此。</p><h2 id="文件树结构"><a href="#文件树结构" class="headerlink" title="文件树结构"></a>文件树结构</h2><p>根据生信分析的一般步骤，我目前使用的文件树结构如下，目前展示的是一个以 R 语言为主的示例，当然也可以很轻松的改变为 Python 为主，或者 Python 与 R 语言混用的结构：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── data/</span><br><span class="line">│    ├ raw/</span><br><span class="line">│    │    ├ GSExxxxxx_RAW/</span><br><span class="line">│    │    └ ...</span><br><span class="line">│    └ processed/</span><br><span class="line">│         ├ 1_preprocess.Rdata</span><br><span class="line">│         └ ...</span><br><span class="line">├── src/</span><br><span class="line">│    ├ main/</span><br><span class="line">│    │    ├ 1_preprocess.R</span><br><span class="line">│    └ utils/</span><br><span class="line">│         ├ plot_volcano.R</span><br><span class="line">│         └ ...</span><br><span class="line">├── output/</span><br><span class="line">│    ├ figures/</span><br><span class="line">│    │    ├ 1_preprocess/</span><br><span class="line">│    │    │    ├ 1_1_density.png</span><br><span class="line">│    │    │    └ ...</span><br><span class="line">│    │    └ ...</span><br><span class="line">│    └ tables/</span><br><span class="line">│         ├ 1_preprocess/</span><br><span class="line">│         │    ├ 1_1_expr.csv</span><br><span class="line">│         │    └ ...</span><br><span class="line">│         └ ...</span><br><span class="line">├── report/</span><br><span class="line">│    ├ 1_preprocess.md</span><br><span class="line">│    └ ...</span><br><span class="line">├── README.md</span><br><span class="line">└── ...</span><br></pre></td></tr></table></figure><ol><li><code>data/</code>：存放数据：<ol><li><code>raw/</code>：存放原始数据，按照数据来源或数据格式安排子文件夹；</li><li><code>processed/</code>：存放处理后的数据，每一个分析步骤对应一个结果文件，R 语言使用 <code>.Rdata</code> 格式，Python 可以使用 <code>.pkl</code> 或 <code>.h5ad</code> 格式等等；</li></ol></li><li><code>src/</code>：存放源代码：<ol><li><code>main/</code>：存放主要代码，每一个文件对应一个分析步骤，比如数据预处理、差异分析、富集分析等等；</li><li><code>utils/</code>：存放工具函数，比如差异分析时常需要画火山图，我就会写一个 <code>plot_volcano.R</code> ，然后在主文件中使用 <code>source(&quot;src/utils/plot_volcano.R&quot;)</code> 引入，等等，这样可以极大的提高代码的可复用性，甚至可以将工具函数写成一个包，方便其他项目使用，或者发到 CRAN 仓库，等等；</li></ol></li><li><code>output/</code>：存放输出结果：<ol><li><code>figures/</code>：存放图片，按照步骤和子步骤安排子文件夹，做好编号，对应结果产生的顺序；</li><li><code>tables/</code>：存放表格，同样按照步骤和子步骤安排子文件夹，做好编号，对应结果产生的顺序；</li><li>当然如果有其他格式的结果输出，也可以自行安排别的文件夹；</li></ol></li><li><code>report/</code>：存放报告，可以是 <code>.md</code> &#x2F; <code>.Rmd</code> 格式，也可以是 <code>.pdf</code> 格式，或者 <code>.docx</code> 格式等等，每个文件对应一个分析步骤，将分析的流程与相应的结果解释清楚呈现在报告中；</li><li><code>README.md</code>：项目描述文件，可以写一个项目简介，项目结构，项目依赖等等，这样别人可以快速了解你的项目；</li><li>其他文件， 比如 <code>LISENSE</code> 或者 <code>requirements.txt</code> 等等，根据项目需要自行添加。</li></ol><h2 id="创建文件树"><a href="#创建文件树" class="headerlink" title="创建文件树"></a>创建文件树</h2><p>每次都手动创建这么多文件夹还挺麻烦的，<code>Windows</code> 环境下我们可以使用批处理文件批量生成文件夹，<code>Linux</code> 或者 <code>Mac</code> 环境下也可以使用 <code>shell</code> 脚本批量生成文件夹。</p><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>创建 <code>init_dir.bat</code> 文件，内容如下：</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">md</span> data</span><br><span class="line"><span class="built_in">md</span> data\raw</span><br><span class="line"><span class="built_in">md</span> data\processed</span><br><span class="line"><span class="built_in">md</span> src</span><br><span class="line"><span class="built_in">md</span> src\main</span><br><span class="line"><span class="built_in">md</span> src\utils</span><br><span class="line"><span class="built_in">md</span> output</span><br><span class="line"><span class="built_in">md</span> output\figures</span><br><span class="line"><span class="built_in">md</span> output\tables</span><br><span class="line"><span class="built_in">md</span> report</span><br><span class="line"><span class="built_in">cd</span> .&gt;README.<span class="built_in">md</span></span><br></pre></td></tr></table></figure><p>可以把 <code>init_dir.bat</code> 文件放在项目根目录下，双击即可创建文件树。</p><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>创建 <code>init_dir.sh</code> 文件，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> data</span><br><span class="line"><span class="built_in">mkdir</span> data/raw</span><br><span class="line"><span class="built_in">mkdir</span> data/processed</span><br><span class="line"><span class="built_in">mkdir</span> src</span><br><span class="line"><span class="built_in">mkdir</span> src/main</span><br><span class="line"><span class="built_in">mkdir</span> src/utils</span><br><span class="line"><span class="built_in">mkdir</span> output</span><br><span class="line"><span class="built_in">mkdir</span> output/figures</span><br><span class="line"><span class="built_in">mkdir</span> output/tables</span><br><span class="line"><span class="built_in">mkdir</span> report</span><br><span class="line"><span class="built_in">touch</span> README.md</span><br></pre></td></tr></table></figure><p>可以把 <code>init_dir.sh</code> 文件放在项目根目录下，然后使用 <code>bash init_dir.sh</code> 命令创建文件树。</p><h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>创建 <code>init_dir.sh</code> 文件，内容与上述 <code>Linux</code> 一样，但是 <code>.sh</code> 文件在 <code>Mac</code> 上运行时需要在终端使用 <code>sh init_dir.sh</code> 命令，很不方便，我们可以把后缀名改为 <code>.command</code>，这样 <code>init_dir.command</code> 文件就可以直接在 <code>Finder</code> 中双击运行了。</p><h2 id="其他常见的文件树结构"><a href="#其他常见的文件树结构" class="headerlink" title="其他常见的文件树结构"></a>其他常见的文件树结构</h2><p>其实更常见的文件结构是将每一个步骤单独放在一个文件夹中，比如：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── 1_preprocess/</span><br><span class="line">│    ├── rawdata/</span><br><span class="line">│    ├── 1_preprocess.R</span><br><span class="line">│    ├── 1_1_density.png</span><br><span class="line">│    ├── 1_1_expr.csv</span><br><span class="line">│    ├── 1_preprocess.Rdata</span><br><span class="line">│    └── ...</span><br><span class="line">├── 2_differential_analysis/</span><br><span class="line">│    └── ...</span><br><span class="line">├── report.md</span><br><span class="line">└── ...</span><br></pre></td></tr></table></figure><p>这种结构的好处是每一个步骤所需要的文件都在同一个文件夹中，分析时不用频繁的切换目录；但是缺点是不同的文件类型放在同一个文件夹中很凌乱，也可能会发生误覆盖，而且查看结果时依然需要频繁切换目录。<em>而且我想说，现在大家写代码都会给文本编辑器配置文件树的，不用在终端或者资源管理器里切换目录，反而查看结果的时候因为要打开图片或者 <code>pdf</code> 文件才没有那么方便。</em>总之就我个人而言，我觉得我现在使用的结构更加清爽。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>当然我在这里也只是提供了一个参考，也不是说可以完全符合各种项目的需求，比方说一些工业化程度高的项目会用脚本或者 pipeline 管理工具来进行流水线生产，这样我的这个结构可能就不是非常适用了，当然我也在研究如何提高这方面的适配性，有新的心得了也会发布在这里，大家目前都可以根据自己的需求和项目情况来选择适合自己的文件树结构。</p>]]></content>
      
      
      <categories>
          
          <category> 生信 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件管理 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
